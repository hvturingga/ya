package main

import (
	"encoding/json"
	"fmt"
	"github.com/hvturingga/ya/conf"
	"os"
	"text/template"
)

const constTpl = `// Code generated by go generate; DO NOT EDIT.
package conf

const (
	ClashAPI = "{{ .ClashAPI }}"
)
`

func main() {
	wd, err := os.Getwd()
	if err != nil {
		panic(err)
	}

	f, err := os.ReadFile(fmt.Sprintf("%s/conf/conf.json", wd))
	if err != nil {
		panic(err)
	}

	var config conf.Conf
	if err := json.Unmarshal(f, &config); err != nil {
		panic(err)
	}

	// Generate constants.go
	if err := gen(wd, "conf/constants.go", "constants", constTpl, config); err != nil {
		panic(err)
	}
}

func gen(wd, path, name, content string, data interface{}) error {
	tmpl, err := template.New(name).Parse(content)
	if err != nil {
		return err
	}

	create, err := os.Create(fmt.Sprintf("%s/%s", wd, path))
	if err != nil {
		return err
	}
	defer create.Close()

	if err := tmpl.Execute(create, data); err != nil {
		return err
	}

	return nil
}
